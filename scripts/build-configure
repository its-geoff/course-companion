#!/bin/bash
set -e  # Exit on any error

usage() {
    echo "Usage: $0 [-t] [-c]"
    echo "  -t: Build test files"
    echo "  -c: Enable code coverage"
    exit 1
}

# ---------------------------
# Parse options
# ---------------------------
BUILD_TESTS=0
ENABLE_COVERAGE=0

while getopts ":tc" opt; do
    case $opt in
        t) BUILD_TESTS=1 ;;
        c) ENABLE_COVERAGE=1 ;;
        \?) usage ;;
    esac
done

# ---------------------------
# Set build directories
# ---------------------------
BUILD_DIR="build_main"
if [[ $BUILD_TESTS -eq 1 ]]; then
    BUILD_DIR="build_test"
fi
mkdir -p "$BUILD_DIR"

# ---------------------------
# Set compiler for macOS
# ---------------------------
OS_NAME=$(uname)
if [[ "$OS_NAME" == "Darwin" ]]; then
    # Force AppleClang for coverage to avoid linker/hash issues
    export CC=/usr/bin/clang
    export CXX=/usr/bin/clang++
    LLVM_PROFILE_FILE="$BUILD_DIR/%p.profraw"
    if [[ $ENABLE_COVERAGE -eq 1 ]]; then
        export LLVM_PROFILE_FILE
        # Clean old .profraw files to avoid version mismatch
        rm -f "$BUILD_DIR"/*.profraw || true
        echo "Coverage enabled. LLVM_PROFILE_FILE set to $LLVM_PROFILE_FILE"
    fi
fi

# ---------------------------
# Run Conan install
# ---------------------------
echo "Installing dependencies..."
conan install .. --build=missing -of "$BUILD_DIR"

CMAKE_TOOLCHAIN_FILE="$(pwd)/$BUILD_DIR/conan_toolchain.cmake"

# ---------------------------
# Configure CMake
# ---------------------------
CMAKE_ARGS="-DCMAKE_TOOLCHAIN_FILE=$CMAKE_TOOLCHAIN_FILE"
if [[ $BUILD_TESTS -eq 1 ]]; then
    CMAKE_ARGS="$CMAKE_ARGS -DBUILD_TESTING=ON"
fi
if [[ $ENABLE_COVERAGE -eq 1 ]]; then
    CMAKE_ARGS="$CMAKE_ARGS -DCMAKE_BUILD_TYPE=Debug -DENABLE_COVERAGE=ON"
fi

echo "Configuring build in $BUILD_DIR..."
cmake -S .. -B "$BUILD_DIR" $CMAKE_ARGS

echo "Build configured successfully in $BUILD_DIR"
