name: Promote develop Branch

on:
    schedule:
        - cron: "0 9 * * 0" # weekly on Sunday at 9:00am UTC
    workflow_dispatch: # allow manual triggering

jobs:
    promote:
        permissions:
            contents: write
            pull-requests: write
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set promotion date
              run: |
                  echo "PROMOTION_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

            - name: Create or find promotion PR
              env:
                  GH_TOKEN: ${{ secrets.FINE_GRAINED_TOKEN }}
              run: |
                  PR_NUMBER=$(gh pr list \
                    --repo "${{ github.repository }}" \
                    --base main \
                    --head develop \
                    --state open \
                    --json number \
                    -q '.[0].number')

                  if [ -z "$PR_NUMBER" ]; then
                    PR_URL=$(gh pr create \
                      --repo "${{ github.repository }}" \
                      --base main \
                      --head develop \
                      --title "${PROMOTION_DATE}: weekly promotion to main" \
                      --body "Automated weekly promotion from develop to main.

                  - Generated by GitHub Actions
                  - CI/CD and CodeQL must pass before merge" \
                      --label automated)
                    
                    PR_NUMBER=$(echo "$PR_URL" | grep -oP '/pull/\K\d+')
                    echo "Created PR #$PR_NUMBER"
                  else
                    echo "PR #$PR_NUMBER already exists"
                  fi

                  echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV

            - name: Wait for status checks
              uses: lewagon/wait-on-check-action@v1.3.4
              with:
                  ref: ${{ github.event.pull_request.head.sha || github.sha }}
                  repo-token: ${{ secrets.GITHUB_TOKEN }}
                  wait-interval: 10
                  running-workflow-name: "Promote develop Branch"
                  allowed-conclusions: success,skipped

            - name: Enable auto-merge
              env:
                  GH_TOKEN: ${{ secrets.FINE_GRAINED_TOKEN }}
              run: |
                  if [ -z "$PR_NUMBER" ]; then
                    echo "Error: PR_NUMBER not set"
                    exit 1
                  fi

                  gh pr merge "$PR_NUMBER" --auto --squash
