name: Promote develop Branch

on:
  schedule:
    - cron: '0 9 * * 0'  # weekly on Sunday at 9:00am UTC
  workflow_dispatch:  # allow manual triggering

jobs:
  promote:
    permissions:
      contents: write
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - name: Set promotion date
        run: |
          echo "PROMOTION_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

      - name: Create or find promotion PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=$(gh pr list \
            --repo "${{ github.repository }}" \
            --base main \
            --head develop \
            --state open \
            --json number \
            -q '.[0].number')

          if [ -z "$PR_NUMBER" ]; then
            PR_NUMBER=$(gh pr create \
              --repo "${{ github.repository }}" \
              --base main \
              --head develop \
              --title "${PROMOTION_DATE}: weekly promotion to main" \
              --body "Automated weekly promotion from develop to main.

          - Generated by GitHub Actions
          - CI/CD and CodeQL must pass before merge" \
              --label automated \
              --json number \
              -q .number)
            echo "Created PR #$PR_NUMBER"
          else
            echo "PR #$PR_NUMBER already exists"
          fi

          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV

      - name: Enable auto-merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -z "$PR_NUMBER" ]; then
            echo "Error: PR_NUMBER not set"
            exit 1
          fi
          
          gh pr merge "$PR_NUMBER" --auto --squash